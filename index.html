<html>
<head>
<script>
var state=0,
	px=py=300,
	pw=19,
	ph=32,
	xv=yv=0,
	v=8,
	ex=ey=50,
	ew=20,
	eh=20,
	exv=eyv=0,
	debug=false,
	grav=0.5,
	onG=false,
	currentPlat='{}',
	holdLeft=holdRight=false,
	plat=[],
	score=0,
	tick,
	goal={x:0,y:0,w:32,h:48},
	grid=16,
	startButton={x:0,y:0,w:200,h:50},
	imgLib={};
	imgLib.bg		= new Image();
	imgLib.bg.src	= 'bg.gif';

	imgLib.floor		= new Image();
	imgLib.floor.src	= 'flatground.gif';

	imgLib.platform		= new Image();
	imgLib.platform.src	= 'platform.gif';

	imgLib.goal		= new Image();
	imgLib.goal.src	= 'wall.gif';


window.onload=function() {
	state=1;
	canv=document.getElementById("gc");
	startButton.x=canv.width/2-startButton.w/2;
	startButton.y=canv.height/2-startButton.h/2+60;
	ctx=canv.getContext("2d");
	ctx.font="30px Arial";
	document.addEventListener("keydown",keyDown);
	document.addEventListener("keyup",keyUp);
	canv.addEventListener('click', (e) => {
		const mousePos = {
			x: e.clientX - canv.offsetLeft,
			y: e.clientY - canv.offsetTop
		};
		if(state == 2 || state == 4) {
			if(
				mousePos.x>=startButton.x && 
				mousePos.x<=startButton.x+startButton.w && 
				mousePos.y>=startButton.y && 
				mousePos.y<=startButton.y+startButton.h
			) {
				init();
				return;
			}
		}
	});
	splashScreen(true);
}
function splashScreen(firstGame=false) {
	state=2;
	ctx.fillStyle=ctx.createPattern(imgLib.bg, 'repeat');
	ctx.fillRect(0,0,canv.width,canv.height);
	clearInterval(tick);
	var heightOffset = canv.height/2-30;
	ctx.fillStyle="white";
	if(!firstGame) {
		state=4;
		//Draw Score
		ctx.fillText("Game Over",canv.width/2-77,heightOffset);
		heightOffset = heightOffset+40;
		ctx.fillText("Final Score: " + score,canv.width/2-92,heightOffset);
	}else{
		ctx.fillText("Game Title",canv.width/2-77,heightOffset);
	}
	ctx.fillStyle="white";
	ctx.fillRect(startButton.x,startButton.y,startButton.w,startButton.h);
	ctx.fillStyle="black";
	ctx.fillText("Start",canv.width/2-33,startButton.y+35);
}
function init() {
	state=3;
	px=py=300;
	xv=yv=0;
	ex=ey=50;
	tick=setInterval(update,1000/30);
	refresh();
}
function refresh() {
	plat=[];
	for(i=0;i<50;i++) {
		var platform = {
		x:getBase16(getRandomInt(0,canv.width)),
		y:getBase16(getRandomInt(0,canv.height)),
		w:getBase16(Math.random()*100+30),
		h:getBase16(Math.random()*30+20),
		c:imgLib.platform,
		f:imgLib.floor
		}
		if(platform.x < 0 || platform.x+platform.w > canv.width ||
			platform.y < 0 || platform.y+platform.h > canv.height){
			continue;
		};
		plat.push(platform);
	}
	plat.sort(function (a, b) {
		return b.y - a.y;
	});
	place_goal(plat);
	exv=1;
	eyv=1;
}
function update() {
	//Player Movement
	if(holdLeft) {
		xv=-v;
	}
	if(holdRight) {
		xv=v;
	}
	px+=xv;
	py+=yv;
	if(onG) {
		xv *= 0.8;
	} else {
		if(yv < 15) {
			yv += grav
		};
	}

	onG=false;

	//Enemy Movement
	diffX = px - ex;
	diffY = (py - ph/2) - ey;
	if(diffX > 2 || diffX < -2) {
		if(diffX > 0)
			ex += 1+exv;
		else
			ex -= 1+exv;
	}
	if(diffY > 2 || diffY < -2) {
		if(diffY > 0)
			ey += 1+eyv;
		else
			ey -= 1+eyv;
	}

	//Player in Goal
	if(
		px+(pw/2)>=goal.x && 
		px+(pw/2)<=goal.x+goal.w && 
		py-(ph/2)>=goal.y && 
		py-(ph/2)<=goal.y+goal.h
	) {
		console.log("In the goal");
		score++;
		refresh();
		return;
	}

	//Enemy on Player
	if(
		ex+(ew/2)>=px && 
		ex+(ew/2)<=px+pw && 
		ey-(eh/2)>=py-ph && 
		ey-(eh/2)<=py
	) {
		console.log("Game Over");
		splashScreen();
		return;
	}

	currentPlat = '{}';
	for(i=0;i<plat.length;i++) {
		if(
			(
				px >= plat[i].x && 
				px <= plat[i].x + plat[i].w && 
				py >= plat[i].y && 
				py <= plat[i].y + plat[i].h-(grid/2)
			) || (
				px+pw >= plat[i].x &&
				px+pw <= plat[i].x + plat[i].w && 
				py >= plat[i].y && 
				py <= plat[i].y+plat[i].h-(grid/2)
			)
			
		) {
			currentPlat = JSON.stringify(plat[i]);
			py=plat[i].y-1;
			onG=true;
		}
	}
	if(py>canv.height+10) {
		py=1;
		if(eyv<4){++eyv};
		if(exv<4){++exv};
	}
	if(py<-10) {
		py=canv.height-1;
		if(eyv<4){++eyv};
		if(exv<4){++exv};
	}
	if(px>canv.width+10) {
		px=1;
		if(eyv<4){++eyv};
		if(exv<4){++exv};
	}
	if(px<-10) {
		px=canv.width-1;
		if(eyv<4){++eyv};
		if(exv<4){++exv};
	}

	//Draw Background
	ctx.fillStyle=ctx.createPattern(imgLib.bg, 'repeat');
	ctx.fillRect(0,0,canv.width,canv.height);

	for(i=0;i<plat.length;i++) {
	//Build platfrom
		ctx.fillStyle=ctx.createPattern(plat[i].c, 'repeat');
		ctx.fillRect(plat[i].x,plat[i].y,plat[i].w,plat[i].h);

	//Build platfrom floor
		ctx.fillStyle=ctx.createPattern(plat[i].f, 'repeat');
		ctx.fillRect(plat[i].x,plat[i].y,plat[i].w,grid);
	}

	//Draw Goal
	ctx.fillStyle=ctx.createPattern(imgLib.goal, 'repeat');
	ctx.fillRect(goal.x,goal.y,goal.w,goal.h);

	//Draw Player
	ctx.fillStyle="white";
	ctx.fillRect(Math.floor(px),Math.floor(py-ph),pw,ph);

	//Draw Enemy
	ctx.fillStyle="red";
	ctx.fillRect(Math.floor(ex),Math.floor(ey-eh),ew,eh);

	//Draw Score
	ctx.fillStyle="white";
	ctx.fillText(score,10,40);

	if(debug) {
		ctx.save();

		ctx.fillStyle="red";
		ctx.fillRect(Math.floor(px),Math.floor(py-2),2,2);
		ctx.fillRect(Math.floor(px+pw-2),Math.floor(py-2),2,2);
		ctx.fillRect(Math.floor(px+(pw/2)-1),Math.floor(py-(ph/2)-1),3,3);


		ctx.font="10px monospace";
		var debuglog = [
			"X: " + Math.round(px),
			"Y: " + Math.round(py),
			"VelY: " + Math.round(yv),
			"Moving: " + holdLeft || holdRight,
			"Jumping: " + !onG,
			"Grounded: " + onG,
			"Interacting with: " + currentPlat,
			"Goal:",
			"- TopLeft("+goal.x+"/"+goal.y+")",
			"- TopRight("+(goal.x+goal.w)+"/"+goal.y+")",
			"- BottomLeft("+goal.x+"/"+(goal.y+goal.h)+")",
			"- BottomRight("+(goal.x+goal.w)+"/"+(goal.y+goal.h)+")"
		];
		ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
		ctx.fillRect(10,50,150,12*debuglog.length);

		ctx.fillStyle="white";
		for (var i = 0; i < debuglog.length; i++) {
			ctx.fillText(debuglog[i],10,60+12*i);
		};
		ctx.restore();
	}
}
function place_goal(platformList) {
	for (var i = 0; i < platformList.length; i++) {
		var rerollGoal			= false,
			currentPlatform 	= platformList[i],
			currentGoalCheck 	= {
				x: getBase16(currentPlatform.x + (currentPlatform.w/2) - goal.w/2),
				y: Math.floor(currentPlatform.y - goal.h+1),
				w: goal.w,
				h: goal.h
			};
		for (var j = 0; j < platformList.length; j++) {
			if(i==j) {continue;};
			//console.log("Test platform "+i+"-"+j);
			if(
				//Check top left corner for overlap
				(currentGoalCheck.x>plat[j].x && currentGoalCheck.x<plat[j].x+plat[j].w &&
					currentGoalCheck.y>plat[j].y && currentGoalCheck.y<plat[j].y+plat[j].h) ||

				//Check top right corner for overlap
				(currentGoalCheck.x+currentGoalCheck.w>plat[j].x && currentGoalCheck.x+currentGoalCheck.w<plat[j].x+plat[j].w &&
					currentGoalCheck.y>plat[j].y && currentGoalCheck.y<plat[j].y+plat[j].h) ||

				//Check bottom left corner for overlap
				(currentGoalCheck.x>plat[j].x && currentGoalCheck.x<plat[j].x+plat[j].w &&
					currentGoalCheck.y+currentGoalCheck.h>plat[j].y && currentGoalCheck.y+currentGoalCheck.h<plat[j].y+plat[j].h) ||

				//Check bottom right corner for overlap
				(currentGoalCheck.x+currentGoalCheck.w>plat[j].x && currentGoalCheck.x+currentGoalCheck.w<plat[j].x+plat[j].w &&
					currentGoalCheck.y+currentGoalCheck.h>plat[j].y && currentGoalCheck.y+currentGoalCheck.h<plat[j].y+plat[j].h)
				){

				//Overlapping with another block
				//console.log("Test platform "+i+"-"+j+": Overlap");
				rerollGoal = true;
				break;
			}else{	
				//console.log("Test platform "+i+"-"+j+": No overlap");
			}
		}
		if(!rerollGoal) {
			//console.log("Test platform "+i+": success");
			goal.x = currentGoalCheck.x;
			goal.y = currentGoalCheck.y;
			//console.log("Goal");
			//console.log(goal);
			return;
		};
	}
	refresh();
	return;
}
function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1) + min);
}
function getBase16(num) {
  return Math.ceil(num / 16) * 16;
}
function keyDown(evt) {
	switch(evt.keyCode) {
		case 37:
			holdLeft=true;
			break;
		case 38:
			if(onG) {
				yv=-10;
			}
			break;
		case 39:
			holdRight=true;
			break;
	}
}
function keyUp(evt) {
	switch(evt.keyCode) {
		case 37:
			holdLeft=false;
			break;
		case 38:
			if(yv<-3) {
				yv=-3;
			}
			break;
		case 39:
			holdRight=false;
			break;
	}
}
</script>
</head>
<body>
<canvas id="gc" width="800" height="592"></canvas>
</body>
</html>