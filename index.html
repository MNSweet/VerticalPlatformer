<html>
<head>
<script>
var game = {
		'canv':false,
		'state':0,
		'debug':false,
		'gravity':0.8,
		'currentPlatforms':'{}',
		'platforms':[],
		'score':0,
		'tick':false,
		'grid':32,
		'startButton': {
			'x':0,
			'y':0,
			'width':200,
			'height':50
		},
		'goal': {
			'x':0,
			'y':0,
			'width':32,
			'height':64
		},
		'interaction': {
			'goLeft':false,
			'goRight':false 
		}
	},
	player = {
		'x':300,
		'y':300,
		'width':25,
		'height':32,
		'direction':0,
		'animationFrame':0,
		'xVelocity':0,
		'yVelocity':0,
		'velocityModifier':8,
		'onGround':false
	},
	enemy1 = {
		'x':50,
		'y':50,
		'width':64,
		'height':64,
		'direction':0,
		'animationFrame':1,
		'xVelocity':0,
		'yVelocity':0,
		'velocityModifier':8
	},
	imgLib = {};
		imgLib.bg		= new Image();
		imgLib.bg.src	= 'bg.jpg';

		imgLib.floor		= new Image();
		imgLib.floor.src	= 'flatground.jpg';

		imgLib.platform		= new Image();
		imgLib.platform.src	= 'platform.jpg';

		imgLib.light		= new Image();
		imgLib.light.src	= 'light.jpg';

		imgLib.goal		= new Image();
		imgLib.goal.src	= 'exit.jpg';

		imgLib.monster		= new Image();
		imgLib.monster.src	= 'monster.png';

		imgLib.hero		= new Image();
		imgLib.hero.src	= 'hero.gif';


window.onload = function() {
	game.state = 1;
	game.canv = document.getElementById("gc");
	game.startButton.x = game.canv.width/2-game.startButton.width/2;
	game.startButton.y = game.canv.height/2-game.startButton.height/2+60;
	ctx = game.canv.getContext("2d");
	ctx.font ="30px Arial";
	document.addEventListener("keydown",keyDown);
	document.addEventListener("keyup",keyUp);
	game.canv.addEventListener('click', (e) => {
		const mousePos = {
			x: e.clientX - game.canv.offsetLeft,
			y: e.clientY - game.canv.offsetTop
		};
		if(game.state == 2 || game.state == 4) {
			if(
				mousePos.x>= game.startButton.x && 
				mousePos.x<= game.startButton.x+game.startButton.width && 
				mousePos.y>= game.startButton.y && 
				mousePos.y<= game.startButton.y+game.startButton.height
			) {
				init();
				return;
			}
		}
	});
	splashScreen(true);
}
function splashScreen(firstGame = false) {
	game.state = 2;
	ctx.fillStyle = ctx.createPattern(imgLib.bg, 'repeat');
	ctx.fillRect(0,0,game.canv.width,game.canv.height);
	clearInterval(game.tick);
	var heightOffset = game.canv.height/2-30;
	ctx.fillStyle ="white";
	if(!firstGame) {
		game.state = 4;
		//Draw Score
		ctx.fillText("Game Over",game.canv.width/2-77,heightOffset);
		heightOffset = heightOffset+40;
		ctx.fillText("Final Score: " + game.score,game.canv.width/2-92,heightOffset);
	}else{
		ctx.fillText("Game Title",game.canv.width/2-77,heightOffset);
	}
	ctx.fillStyle ="white";
	ctx.fillRect(game.startButton.x,game.startButton.y,game.startButton.width,game.startButton.height);
	ctx.fillStyle ="black";
	ctx.fillText("Start",game.canv.width/2-33,game.startButton.y+35);
}
function init() {
	game.state = 3;	
	game.score = 0;
	player.x = player.y = 300;
	player.xVelocity = player.yVelocity = 0;
	enemy1.x = enemy1.y = 50;
	game.tick = setInterval(update,1000/30);
	refresh();
}
function refresh() {
	game.platforms =[];
	for(i = 0;i<30;i++) {
		var platform = {
		x:getBase16(getRandomInt(0,game.canv.width)),
		y:getBase16(getRandomInt(0,game.canv.height)),
		w:getBase16(Math.random()*100+30),
		h:getBase16(Math.random()*30+20),
		c:imgLib.platform,
		f:imgLib.floor
		}
		if(platform.x < 0 || platform.x+platform.w > game.canv.width ||
			platform.y < 0 || platform.y+platform.h > game.canv.height){
			continue;
		};
		game.platforms.push(platform);
	}
	game.platforms.sort(function (a, b) {
		return b.y - a.y;
	});
	place_goal(game.platforms);
	enemy1.xVelocity = 1;
	enemy1.yVelocity = 1;
}
function update() {
	//Player Movement
	if(game.interaction.goLeft) {
		player.direction = 1;
		player.animationFrame = player.animationFrame+.8;
		player.xVelocity =-player.velocityModifier;
	}
	if(game.interaction.goRight) {
		player.direction = 0;
		player.animationFrame = player.animationFrame+.8;
		player.xVelocity = player.velocityModifier;
	}
	if(player.animationFrame >= 4) {player.animationFrame = 0};
	if(enemy1.animationFrame > 3) {enemy1.animationFrame = 0};
	player.x+= player.xVelocity;
	player.y+= player.yVelocity;
	if(player.onGround) {
		player.xVelocity *= 0.8;
	} else {
		if(player.yVelocity < 15) {
			player.yVelocity += game.gravity
		};
		if(player.yVelocity > 0) {player.animationFrame = 4;}
		else {player.animationFrame = 5;}
	}

	player.onGround = false;

	//Enemy Movement
	diffX = (player.x + player.width/2) - (enemy1.x + enemy1.width/2);
	diffY = (player.y - player.height/3*2) - (enemy1.y - enemy1.height/2);
	if(diffX > 1 || diffX < -1) {
		if(diffX > 0) {
			enemy1.direction = 0;
			enemy1.x += 1+enemy1.xVelocity;
		}
		else {
			enemy1.direction = 1;
			enemy1.x -= 1+enemy1.xVelocity;
		}
	}
	if(diffY > 1 || diffY < -1) {
		if(diffY > 0)
			enemy1.y += 1+enemy1.yVelocity;
		else
			enemy1.y -= 1+enemy1.yVelocity;
	}

	//Player in Goal
	if(
		player.x+(player.width/2)>= game.goal.x && 
		player.x+(player.width/2)<= game.goal.x+game.goal.width && 
		player.y-(player.height/2)>= game.goal.y && 
		player.y-(player.height/2)<= game.goal.y+game.goal.height
	) {
		game.score++;
		refresh();
		return;
	}

	//Enemy on Player
	if(
		enemy1.x+(enemy1.width/2)>= player.x && 
		enemy1.x+(enemy1.width/2)<= player.x+player.width && 
		enemy1.y-(enemy1.height/2)>= player.y-player.height && 
		enemy1.y-(enemy1.height/2)<= player.y
	) {
		splashScreen();
		return;
	}

	game.currentPlatform = '{}';
	for(i = 0;i<game.platforms.length;i++) {
		if(
			(
				player.x >= game.platforms[i].x && 
				player.x <= game.platforms[i].x + game.platforms[i].w && 
				player.y >= game.platforms[i].y && 
				player.y <= game.platforms[i].y+32// + game.platforms[i].h-(game.grid/2)
			) || (
				player.x+player.width >= game.platforms[i].x &&
				player.x+player.width <= game.platforms[i].x + game.platforms[i].w && 
				player.y >= game.platforms[i].y && 
				player.y <= game.platforms[i].y+32//game.platforms[i].h-(game.grid/2)
			)
			
		) {
			game.currentPlatform = JSON.stringify(game.platforms[i]);
			player.y = game.platforms[i].y-1;
			player.onGround = true;
		}
	}
	if(player.y>game.canv.height+10) {
		player.y = 1;
		if(enemy1.yVelocity<4){++enemy1.yVelocity};
		if(enemy1.xVelocity<4){++enemy1.xVelocity};
	}
	if(player.y<-10) {
		player.y = game.canv.height-1;
		if(enemy1.yVelocity<4){++enemy1.yVelocity};
		if(enemy1.xVelocity<4){++enemy1.xVelocity};
	}
	if(player.x>game.canv.width+10) {
		player.x = 1;
		if(enemy1.yVelocity<4){++enemy1.yVelocity};
		if(enemy1.xVelocity<4){++enemy1.xVelocity};
	}
	if(player.x<-10) {
		player.x = game.canv.width-1;
		if(enemy1.yVelocity<4){++enemy1.yVelocity};
		if(enemy1.xVelocity<4){++enemy1.xVelocity};
	}

	//Draw Background
	ctx.fillStyle = ctx.createPattern(imgLib.bg, 'repeat');
	ctx.fillRect(0,0,game.canv.width,game.canv.height);

	for(i = 0;i<game.platforms.length;i++) {
	//Build platfrom
		ctx.fillStyle = ctx.createPattern(game.platforms[i].c, 'repeat');
		ctx.fillRect(game.platforms[i].x,game.platforms[i].y,game.platforms[i].w,game.platforms[i].h);

	//Build platfrom floor
		ctx.fillStyle = ctx.createPattern(game.platforms[i].f, 'repeat');
		ctx.fillRect(game.platforms[i].x,game.platforms[i].y,game.platforms[i].w,game.grid/4);

	//Build platfrom floor
		ctx.fillStyle = ctx.createPattern(imgLib.light, 'repeat');
		ctx.fillRect(game.platforms[i].x,game.platforms[i].y-game.grid,game.platforms[i].w,game.grid);
	}

	//Draw Goal
	ctx.drawImage(
		imgLib.goal, //image
		0, //start crop x
		0, //start crop y
		game.grid*2,//crop width
		game.grid*3,//crop height
		game.goal.x, //render x
		game.goal.y,//render y
		game.goal.width, //render width
		game.goal.height //render height
	)

	//Draw Player
	ctx.drawImage(
		imgLib.hero, //image
		Math.floor(player.animationFrame) * 32, //start crop x
		player.direction * 32, //start crop y
		player.width,//crop width
		player.height,//crop height
		Math.floor(player.x), //render x
		Math.floor(player.y-player.height),//render y
		player.width, //render width
		player.height //render height
	)

	//Draw Enemy
	enemy1.animationFrame = enemy1.animationFrame+.6;
	if(enemy1.animationFrame > 3) {enemy1.animationFrame = 0};
	var flyingMod = Math.floor(enemy1.animationFrame) % 4;

	ctx.drawImage(
		imgLib.monster, //image
		flyingMod * 64, //start crop x
		enemy1.direction * 64, //start crop y
		enemy1.width, //crop width
		enemy1.height,//crop height
		Math.floor(enemy1.x), //render x
		Math.floor(enemy1.y-enemy1.height),//render y
		enemy1.width, //render width
		enemy1.height //render height
	)

	//Draw Score
	ctx.fillStyle ="white";
	ctx.fillText(game.score,10,40);

	if(game.debug) {
		ctx.save();

		ctx.fillStyle ="red";
		ctx.fillRect(enemy1.x+(enemy1.width/2),0,1,game.canv.width);
		ctx.fillRect(0,enemy1.y-(enemy1.height/2),game.canv.height,1);
		ctx.fillRect(Math.floor(player.x),Math.floor(player.y-2),2,2);
		ctx.fillRect(Math.floor(player.x+player.width-2),Math.floor(player.y-2),2,2);
		ctx.fillRect(Math.floor(player.x+(player.width/2)-1),Math.floor(player.y-(player.height/2)-1),3,3);


		ctx.font ="10px monospace";
		var debuglog = [
			"X: " + Math.round(player.x),
			"Y: " + Math.round(player.y),
			"VelY: " + Math.round(player.yVelocity),
			"Moving: " + game.interaction.goLeft || game.interaction.goRight,
			"Jumping: " + !player.onGround,
			"Grounded: " + player.onGround,
			"Interacting with: " + game.currentPlatform,
			"Goal:",
			"- TopLeft("+game.goal.x+"/"+game.goal.y+")",
			"- TopRight("+(game.goal.x+game.goal.width)+"/"+game.goal.y+")",
			"- BottomLeft("+game.goal.x+"/"+(game.goal.y+game.goal.height)+")",
			"- BottomRight("+(game.goal.x+game.goal.width)+"/"+(game.goal.y+game.goal.height)+")"
		];
		ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
		ctx.fillRect(10,50,150,12*debuglog.length);

		ctx.fillStyle ="white";
		for (var i = 0; i < debuglog.length; i++) {
			ctx.fillText(debuglog[i],10,60+12*i);
		};
		ctx.restore();
	}
}
function place_goal(platformList) {
	for (var i = 0; i < platformList.length; i++) {
		var rerollGoal			= false,
			currentPlatform 	= platformList[i],
			currentGoalCheck 	= {
				x: getBase16(currentPlatform.x + (currentPlatform.w/2) - game.goal.width/2),
				y: Math.floor(currentPlatform.y - game.goal.height+1),
				w: game.goal.width,
				h: game.goal.height
			};
		for (var j = 0; j < platformList.length; j++) {
			if(i == j) {continue;};
			if(
				//Check top left corner for overlap
				(currentGoalCheck.x>game.platforms[j].x && currentGoalCheck.x<game.platforms[j].x+game.platforms[j].w &&
					currentGoalCheck.y>game.platforms[j].y && currentGoalCheck.y<game.platforms[j].y+game.platforms[j].h) ||

				//Check top right corner for overlap
				(currentGoalCheck.x+currentGoalCheck.w>game.platforms[j].x && currentGoalCheck.x+currentGoalCheck.w<game.platforms[j].x+game.platforms[j].w &&
					currentGoalCheck.y>game.platforms[j].y && currentGoalCheck.y<game.platforms[j].y+game.platforms[j].h) ||

				//Check bottom left corner for overlap
				(currentGoalCheck.x>game.platforms[j].x && currentGoalCheck.x<game.platforms[j].x+game.platforms[j].w &&
					currentGoalCheck.y+currentGoalCheck.h>game.platforms[j].y && currentGoalCheck.y+currentGoalCheck.h<game.platforms[j].y+game.platforms[j].h) ||

				//Check bottom right corner for overlap
				(currentGoalCheck.x+currentGoalCheck.w>game.platforms[j].x && currentGoalCheck.x+currentGoalCheck.w<game.platforms[j].x+game.platforms[j].w &&
					currentGoalCheck.y+currentGoalCheck.h>game.platforms[j].y && currentGoalCheck.y+currentGoalCheck.h<game.platforms[j].y+game.platforms[j].h)
				){

				//Overlapping with another block
				rerollGoal = true;
				break;
			}
		}
		if(!rerollGoal) {
			game.goal.x = currentGoalCheck.x;
			game.goal.y = currentGoalCheck.y-1;
			return;
		};
	}
	refresh();
	return;
}
function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1) + min);
}
function getBase16(num) {
  return Math.ceil(num / 32) * 32;
}
function keyDown(evt) {
	switch(evt.keyCode) {
		case 37:
			game.interaction.goLeft = true;
			break;
		case 38:
			if(player.onGround) {
				player.yVelocity =-10;
			}
			break;
		case 39:
			game.interaction.goRight = true;
			break;
	}
}
function keyUp(evt) {
	switch(evt.keyCode) {
		case 37:
			game.interaction.goLeft = false;
			break;
		case 38:
			if(player.yVelocity<-3) {
				player.yVelocity =-3;
			}
			break;
		case 39:
			game.interaction.goRight = false;
			break;
	}
}

</script>
</head>
<body>
<canvas id ="gc" width ="800" height ="592"></canvas>
</body>
</html>